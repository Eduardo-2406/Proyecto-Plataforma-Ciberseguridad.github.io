import{h as M,a as T,u as j,f as L,r as l,b as v,c as f,s as w,R as e,i as U}from"./index-BS11OSAT.js";import{e as Q}from"./evaluations-2M7BGk-T.js";const V=()=>{const{id:i}=M(),N=T(),{currentUser:m}=j(),{saveEvaluation:R}=L(),[s,$]=l.useState(null),[o,p]=l.useState(0),[c,y]=l.useState({}),[u,S]=l.useState(null),[D,g]=l.useState(!0),[C,h]=l.useState(""),[E,k]=l.useState(!1);l.useEffect(()=>{if(!m){N("/login");return}(async()=>{try{const a=Q[i];a?($(a),S(a.duration*60),g(!1)):(h("Evaluación no encontrada"),g(!1));const r=v(f,`users/${m.uid}/evaluations/${i}`),n=await U(r);if(n.exists()){const b=n.val();b.completed||(p(b.currentQuestion||0),y(b.answers||{}))}}catch(a){console.error("Error al cargar la evaluación:",a),h("Error al cargar la evaluación"),g(!1)}})()},[i,m,N]),l.useEffect(()=>{if(!u||E)return;const t=setInterval(()=>{S(a=>a<=1?(clearInterval(t),A(),0):a-1)},1e3);return()=>clearInterval(t)},[u,E]);const I=(t,a)=>{y(n=>({...n,[t]:a}));const r=v(f,`users/${m.uid}/evaluations/${i}`);w(r,{currentQuestion:o,answers:{...c,[t]:a},lastUpdated:new Date().toISOString()})},O=()=>{o<s.questions.length-1&&p(t=>t+1)},P=()=>{o>0&&p(t=>t-1)},q=()=>{let t=0;return s.questions.forEach(a=>{c[a.id]===a.correctAnswer&&t++}),Math.round(t/s.questions.length*100)},x=async t=>{try{const a=`cert_${Date.now()}`,r={id:a,title:`Certificado de ${s.title}`,recipientName:m.displayName||"Usuario",issuer:"Plataforma de Ciberseguridad",issueDate:new Date().toISOString(),evaluationId:i,score:t,evaluationTitle:s.title,verificationCode:`CERT-${Math.random().toString(36).substr(2,9).toUpperCase()}`},n=v(f,`users/${m.uid}/certificates/${a}`);return await w(n,r),r}catch(a){throw console.error("Error al generar certificado:",a),a}},A=async()=>{if(E)return;const t=q(),a={evaluationId:i,completed:!0,score:t,correctAnswers:Object.values(c).filter((r,n)=>r===s.questions[n].correctAnswer).length,incorrectAnswers:Object.values(c).filter((r,n)=>r!==s.questions[n].correctAnswer).length,completedAt:new Date().toISOString(),points:Math.round(t*10),answers:c};try{const r=v(f,`users/${m.uid}/evaluations/${i}`);await w(r,a),await R(i,a),t>=s.passingScore&&await x(t),k(!0)}catch(r){console.error("Error al guardar los resultados:",r),h("Error al guardar los resultados")}};if(D)return e.createElement("div",{className:"evaluation-container"},e.createElement("div",{className:"loading"},"Cargando evaluación..."));if(C)return e.createElement("div",{className:"evaluation-container"},e.createElement("div",{className:"error-message"},C));if(E){const t=q(),a=t>=s.passingScore;return e.createElement("div",{className:"evaluation-container result-page"},e.createElement("div",{className:"result-container"},e.createElement("div",{className:"result-header"},e.createElement("div",{className:"header-content"},e.createElement("h2",null,"Resultados de la Evaluación"),e.createElement("div",{className:"evaluation-info"},e.createElement("span",{className:"evaluation-title"},s.title),e.createElement("span",{className:"completion-date"},e.createElement("i",{className:"fas fa-calendar-check"}),"Completada el ",new Date().toLocaleDateString())))),e.createElement("div",{className:"score-display"},e.createElement("div",{className:`score-circle ${a?"passed":"failed"}`},e.createElement("div",{className:"score-content"},e.createElement("span",{className:"score-value"},t,"%"),e.createElement("span",{className:"score-label"},a?"¡Aprobado!":"No aprobado"))),e.createElement("div",{className:"score-details"},e.createElement("div",{className:"score-info"},e.createElement("i",{className:"fas fa-percentage"}),e.createElement("div",{className:"info-content"},e.createElement("span",{className:"info-label"},"Puntuación mínima requerida"),e.createElement("span",{className:"info-value"},s.passingScore,"%"))),e.createElement("div",{className:"score-info"},e.createElement("i",{className:"fas fa-clock"}),e.createElement("div",{className:"info-content"},e.createElement("span",{className:"info-label"},"Tiempo utilizado"),e.createElement("span",{className:"info-value"},Math.floor((s.duration*60-u)/60)," minutos"))))),e.createElement("div",{className:"result-details"},e.createElement("div",{className:"result-section"},e.createElement("h3",null,"Resumen de Respuestas"),e.createElement("div",{className:"answers-summary"},e.createElement("div",{className:"summary-item correct"},e.createElement("div",{className:"summary-icon"},e.createElement("i",{className:"fas fa-check-circle"})),e.createElement("div",{className:"summary-content"},e.createElement("span",{className:"summary-value"},Object.values(c).filter((r,n)=>r===s.questions[n].correctAnswer).length),e.createElement("span",{className:"summary-label"},"Respuestas correctas"))),e.createElement("div",{className:"summary-item incorrect"},e.createElement("div",{className:"summary-icon"},e.createElement("i",{className:"fas fa-times-circle"})),e.createElement("div",{className:"summary-content"},e.createElement("span",{className:"summary-value"},Object.values(c).filter((r,n)=>r!==s.questions[n].correctAnswer).length),e.createElement("span",{className:"summary-label"},"Respuestas incorrectas"))),e.createElement("div",{className:"summary-item total"},e.createElement("div",{className:"summary-icon"},e.createElement("i",{className:"fas fa-list-ol"})),e.createElement("div",{className:"summary-content"},e.createElement("span",{className:"summary-value"},s.questions.length),e.createElement("span",{className:"summary-label"},"Total de preguntas")))))),e.createElement("div",{className:"result-actions"},e.createElement("button",{className:"review-button",onClick:()=>k(!1)},e.createElement("i",{className:"fas fa-search"}),"Revisar respuestas"),e.createElement("button",{className:"return-button",onClick:()=>N("/evaluations")},e.createElement("i",{className:"fas fa-arrow-left"}),"Volver a evaluaciones"))))}const d=s.questions[o];return e.createElement("div",{className:"evaluation-container"},e.createElement("div",{className:"evaluation-header"},e.createElement("div",{className:"header-content"},e.createElement("h1",null,s.title),e.createElement("div",{className:"evaluation-meta"},e.createElement("span",{className:"meta-item"},e.createElement("i",{className:"fas fa-list-ol"}),"Pregunta ",o+1," de ",s.questions.length),e.createElement("span",{className:"meta-item timer"},e.createElement("i",{className:"fas fa-clock"}),e.createElement("span",{className:"timer-value"},Math.floor(u/60),":",(u%60).toString().padStart(2,"0")))))),e.createElement("div",{className:"question-container"},e.createElement("div",{className:"question-content"},e.createElement("h2",null,d.text),e.createElement("div",{className:"options-grid"},d.options.map((t,a)=>e.createElement("button",{key:a,className:`option-button ${c[d.id]===t?"selected":""}`,onClick:()=>I(d.id,t)},e.createElement("div",{className:"option-content"},e.createElement("span",{className:"option-letter"},String.fromCharCode(65+a)),e.createElement("span",{className:"option-text"},t)),c[d.id]===t&&e.createElement("i",{className:"fas fa-check option-check"}))))),e.createElement("div",{className:"navigation-buttons"},e.createElement("button",{className:"nav-button",onClick:P,disabled:o===0},e.createElement("i",{className:"fas fa-arrow-left"}),"Anterior"),e.createElement("button",{className:"nav-button",onClick:O,disabled:o===s.questions.length-1},"Siguiente",e.createElement("i",{className:"fas fa-arrow-right"}))),o===s.questions.length-1&&e.createElement("button",{className:"submit-button",onClick:A},e.createElement("i",{className:"fas fa-check-circle"}),"Finalizar Evaluación")))};export{V as default};
